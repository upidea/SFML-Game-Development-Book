
cmake_minimum_required(VERSION 3.11)

# Specify default build type if none provided (before project() command)
if(NOT CMAKE_BUILD_TYPE)
	set(CMAKE_BUILD_TYPE Release CACHE STRING "Choose the type of build (Debug or Release)" FORCE)
endif()

# For generators with multiple configurations (like VS), only allow Debug and Release
if(CMAKE_CONFIGURATION_TYPES)
	set(CMAKE_CONFIGURATION_TYPES "Debug;Release" CACHE STRING "Limited configurations" FORCE)
	mark_as_advanced(CMAKE_CONFIGURATION_TYPES)
endif()

# Project name
project(sfml-book)

find_package(SFML COMPONENTS Network Graphics Window Audio System CONFIG REQUIRED)

######################################################################################################################################


# Interprets an argument list separated with keywords.
# Example: 
#  parse_argument_list("MY" "FIRST;SECOND" "FIRST;a;b;c;SECOND;x;y") defines the following variables:
#  MY_FIRST  = a;b;c
#  MY_SECOND = x;y
macro(parse_argument_list PREFIX KEYWORDS ARGUMENTS)
	# Indirection over KEYWORD_LIST necessary because macro parameters are no real variables.
	set(KEYWORD_LIST "${KEYWORDS}")
	set(CURRENT_KEYWORD "")

	# Parse argument list
	foreach(ARG ${ARGUMENTS})
		# See if current argument is in the list of keywords
		list(FIND KEYWORD_LIST "${ARG}" KEYWORD_FOUND)
		if(NOT KEYWORD_FOUND EQUAL -1)
			# If current element is a keyword, store it
			set(CURRENT_KEYWORD ${ARG})
		else()
			# Append current argument to last stored keyword variable
			set(${PREFIX}_${CURRENT_KEYWORD} ${${PREFIX}_${CURRENT_KEYWORD}};${ARG})
		endif()
	endforeach()
endmacro()

######################################################################################################################################

# Macro for chapter building
# Usage:
#  build_chapter(Audio SOURCES First.cpp Second.cpp)
macro(build_chapter CHAPTER_NAME)

	# Parse additional arguments (fills variables CHAPTER_SOURCES and CHAPTER_DEPENDS)
	parse_argument_list("CHAPTER" "SOURCES" "${ARGN}")

	# Status output
	message(STATUS "-> Chapter ${CHAPTER_NAME}")

	#############################################################################
	# Build executable
	project(${CHAPTER_NAME})

	# Executable: Add only Main.cpp, set name without _EXE postfix
	add_executable(${PROJECT_NAME} Main.cpp ${CHAPTER_SOURCES})
	set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME ${CHAPTER_NAME})

	set(CHAPTER_DIR "${PROJECT_SOURCE_DIR}/..")
	target_include_directories(${PROJECT_NAME} PRIVATE
		"${CHAPTER_DIR}/Include"
		${VCPKG_INSTALLED_DIR}/${VCPKG_TARGET_TRIPLET}/include
	)

	target_link_libraries(${PROJECT_NAME} PRIVATE
		SFML::Network SFML::Graphics SFML::Window SFML::Audio SFML::System
	)

	# 1. è·å–ç›®æ ‡çš„è¾“å‡ºç›®å½•ï¼ˆè‡ªåŠ¨é€‚é…Debug/Release/RelWithDebInfoç­‰é…ç½®ï¼‰
	get_target_property(TARGET_OUTPUT_DIR ${PROJECT_NAME} RUNTIME_OUTPUT_DIRECTORY)
	# å¦‚æœæœªæ˜¾å¼è®¾ç½®è¾“å‡ºç›®å½•ï¼Œä½¿ç”¨é»˜è®¤çš„äºŒè¿›åˆ¶ç›®å½•
	if(NOT TARGET_OUTPUT_DIR)
		# è®¡ç®—æºç ç›®å½•ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„ï¼ˆæ¯”å¦‚ 01_Intro/Sourceï¼‰
		file(RELATIVE_PATH SRC_REL_PATH 
			"${CMAKE_SOURCE_DIR}"  # é¡¹ç›®æ ¹æºç ç›®å½•
			"${PROJECT_SOURCE_DIR}"  # å½“å‰ç« èŠ‚æºç ç›®å½•ï¼š01_Intro/Source
		)
		# æ‹¼æ¥æˆ exe å®é™…è¾“å‡ºç›®å½•ï¼šbuild/01_Intro/Source/Debug
		set(TARGET_OUTPUT_DIR "${CMAKE_BINARY_DIR}/${SRC_REL_PATH}/${CMAKE_BUILD_TYPE}")
	endif()
	# æœ€ç»ˆéªŒè¯ï¼šæ‰“å°æœ€ç»ˆçš„ç›®æ ‡è¾“å‡ºç›®å½•
	message(STATUS "ğŸ‘‰ æœ€ç»ˆ Exe è¾“å‡ºç›®å½•ï¼š${TARGET_OUTPUT_DIR}")

	# 2. å®šä¹‰Mediaæºç›®å½•å’Œç›®æ ‡ç›®å½•
	set(MEDIA_SOURCE_DIR "${CHAPTER_DIR}/Media")
	set(MEDIA_DEST_DIR "${TARGET_OUTPUT_DIR}/Media")

	# 3. åˆ›å»ºè‡ªå®šä¹‰å‘½ä»¤ï¼šæ‹·è´Mediaç›®å½•ï¼ˆæ’é™¤CMakeLists.txtï¼‰
	add_custom_command(
		OUTPUT ${MEDIA_DEST_DIR}  # è¾“å‡ºæ ‡è®°ï¼Œé¿å…é‡å¤æ‹·è´
		COMMAND ${CMAKE_COMMAND} -E make_directory ${MEDIA_DEST_DIR}  # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
		COMMAND ${CMAKE_COMMAND} -E copy_directory
			${MEDIA_SOURCE_DIR}
			${MEDIA_DEST_DIR}
		COMMAND ${CMAKE_COMMAND} -E remove -f ${MEDIA_DEST_DIR}/CMakeLists.txt  # æ’é™¤CMakeLists.txt
		DEPENDS ${MEDIA_SOURCE_DIR}  # æºç›®å½•å˜åŒ–æ—¶é‡æ–°æ‹·è´
		COMMENT "Copying Media directory to ${MEDIA_DEST_DIR}"
	)

	# 4. åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡ï¼Œå¹¶å…³è”åˆ°å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡
	add_custom_target(
		CopyMedia_${CHAPTER_NAME}  # å”¯ä¸€ç›®æ ‡åï¼Œé¿å…å¤šç« èŠ‚å†²çª
		DEPENDS ${MEDIA_DEST_DIR}  # ä¾èµ–æ‹·è´å‘½ä»¤çš„è¾“å‡º
	)

	# 5. å¼ºåˆ¶ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶æ—¶å…ˆæ‰§è¡ŒMediaæ‹·è´
	add_dependencies(${PROJECT_NAME} CopyMedia_${CHAPTER_NAME})	

	install(TARGETS ${PROJECT_NAME}	RUNTIME DESTINATION ${CHAPTER_NAME})

	install(DIRECTORY ${CHAPTER_DIR}/Media
			DESTINATION ${PROJECT_NAME}
			PATTERN "CMakeLists.txt" EXCLUDE)
endmacro()

# C++ source code, list of all subdirectories
# Must appear after macros, otherwise they are not visible in subdirectories
add_subdirectory(01_Intro/Source)
add_subdirectory(02_Resources/Source)
add_subdirectory(03_World/Source)
add_subdirectory(04_Input/Source)
add_subdirectory(05_States/Source)
add_subdirectory(06_Menus/Source)
add_subdirectory(07_Gameplay/Source)
add_subdirectory(08_Graphics/Source)
add_subdirectory(09_Audio/Source)
add_subdirectory(10_Network/Source)
